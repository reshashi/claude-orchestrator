name: Test Install Script

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-install:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install bash 4+ (macOS ships with 3.2)
        run: |
          brew install bash
          # Add Homebrew bash to PATH so #!/usr/bin/env bash finds it
          echo "/opt/homebrew/bin" >> $GITHUB_PATH
          echo "Installed: $(/opt/homebrew/bin/bash --version | head -1)"

      - name: Install iTerm2 (mock check)
        run: |
          # Create mock iTerm2 directory for CI
          sudo mkdir -p /Applications/iTerm.app

      - name: Test local install
        run: |
          echo "Using bash: $(which bash) - $(bash --version | head -1)"
          ./install.sh -y

          # Verify core files exist
          test -f ~/.claude/scripts/orchestrator.sh
          test -f ~/.claude/scripts/orchestrator-loop.sh
          test -f ~/.claude/scripts/wt.sh
          test -f ~/.claude/commands/spawn.md
          test -f ~/.claude/agents/qa-guardian.md

          # Verify memory system files
          test -f ~/.claude/scripts/memory-read.sh
          test -f ~/.claude/scripts/memory-write.sh
          test -f ~/.claude/scripts/migrate-memory.sh
          test -f ~/.claude/scripts/session-summary.sh
          test -f ~/.claude/commands/assistant.md
          test -f ~/.claude/agents/orchestrator-assistant.md

          # Verify 3-tier memory directories (v3.4)
          test -d ~/.claude/orchestrator/global
          test -d ~/.claude/orchestrator/global/projects
          test -d ~/.claude/orchestrator/global/sessions
          test -d ~/.claude/orchestrator/seed
          test -d ~/.claude/orchestrator/user
          test -f ~/.claude/orchestrator/global/toolchain.json
          test -f ~/.claude/orchestrator/global/repos.json
          test -f ~/.claude/orchestrator/global/facts.json
          test -f ~/.claude/orchestrator/user/user-preferences.json
          test -f ~/.claude/orchestrator/user/user-standards.json

          echo "All files installed correctly"

      - name: Test uninstall
        run: |
          ./uninstall.sh

          # Verify install directory removed
          test ! -d ~/.claude-orchestrator

          echo "Uninstall completed correctly"

  test-memory:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies (bash 4+, jq)
        run: |
          brew install bash jq
          echo "/opt/homebrew/bin" >> $GITHUB_PATH

      - name: Make scripts executable
        run: chmod +x scripts/*.sh tests/*.sh

      - name: Run memory system tests
        run: ./tests/test-memory.sh

  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning
